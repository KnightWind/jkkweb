package com.jkkp.modules.basedata.controller;

import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import com.jkkp.common.BaseController;
import com.jkkp.common.interceptor.AccessMenu;
import com.jkkp.common.interceptor.AccessPagination;
import com.jkkp.common.response.ResponseObject;
import com.jkkp.modules.basedata.model.Help;
import com.jkkp.modules.basedata.service.IHelpService;
import com.jkkp.modules.member.service.IMemberService;
import com.jkkp.modules.sale_theme.service.IActivityJionSignService;
import com.jkkp.pc.common.constants.AjaxHelper;
import com.jkkp.utils.Escape;
import com.jkkp.utils.Pagination;

@Controller
@RequestMapping(value = "/help")
public class HelpController extends BaseController {

	@Autowired
	private IHelpService helpService;
	@Autowired
	private IMemberService memberService;
	@Autowired
	private IActivityJionSignService activityJionSignService;
	//现金券编码转换 页面
	@RequestMapping(value="into")
	public String into(){
		return "/help/jl_index";
	}
	
	//现金券编码转换
	@RequestMapping(value="shengcheng.do")
	public void  shengcheng(HttpServletResponse res,String text1,String text2,String text3,String text4) throws IOException{
		text1 = "<p>" + text1 +"</p>";
		text2 = "<p>" + text2 +"</p>";
		text3 = "<p>" + text3 +"</p>";
		text4 = "<p>" + text4 +"</p>";
		String str = text1 + text2 + text3 + text4;
		str = Escape.escape(str);
		Map<String,Object> map = new HashMap<String, Object>();
		map.put("str", str);
		AjaxHelper.objectToJson(res, map);
	}
	
	
	//微信引流用户-家可可用户转换  yemian
	@RequestMapping(value="joinSignInto")
	public String joinSignInto(){
		return "/help/joinSignInto";
	}
	
	@ResponseBody
	@RequestMapping(value="memeberChange.do")
	public Object change(){
		try {
			List<String> memberPhoneList = memberService.getAllMemberPhone();
			List<String> joinSignPhoneList = activityJionSignService.getAllJoinSinPhone();
			Integer num=0;
			for (String joinSign: joinSignPhoneList) {
				Boolean flag=false;
				for (String member : memberPhoneList) {
					if(member.equals(joinSign)){
						flag=true;
					}
				}
				if(flag==false){
					memberService.memeberChange(joinSign);
					num++;
				}
			}
			return new ResponseObject(true, "共转换"+num+"条数据");
		} catch (Exception e) {
			logger.error("用户转换失败");
			return new ResponseObject(false, "提取失败");
		}
	}
	
	@AccessMenu
	@AccessPagination(custom = true, async = AccessPagination.ASYNC.ASYNC_NO)
	@RequestMapping(value = "/index")
	public String list(HttpServletRequest request) {
		request.setAttribute("pagination", helpService.pagination());
		return "/help/help_list";
	}

	@ResponseBody
	@AccessPagination(custom = true, async = AccessPagination.ASYNC.ASYNC_YES)
	@RequestMapping("/pagination.do")
	public void pagination(HttpServletRequest request) {
		Pagination.setContext(helpService);
	}

	@ResponseBody
	@RequestMapping("/show.do")
	public Object show(@RequestParam Integer id, HttpServletRequest request) {
		try {
			helpService.show(id);
			return new ResponseObject(true);
		} catch (Exception e) {
			logger.error("目录显示异常", e);
			return new ResponseObject(false,"目录显示异常");
		}
	}

	@ResponseBody
	@RequestMapping("/hidden.do")
	public Object hidden(@RequestParam Integer id, HttpServletRequest request) {
		try {
			helpService.hidden(id);
			return new ResponseObject(true);
		} catch (Exception e) {
			logger.error("目录隐藏异常", e);
			return new ResponseObject(false,"目录隐藏异常");
		}
	}

	@ResponseBody
	@RequestMapping("/save.do")
	public Object save(Help help) {
		try {
			if(help.getCateId()==null){
				return new ResponseObject(false,"请选择目录分类");
			}
			if(help.getTitle().isEmpty()){                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
				return new ResponseObject(false,"请输入帮助标题");
			}
			if(help.getContent().isEmpty()){
				return new ResponseObject(false,"请输入帮助内容");
			}			
			helpService.saveOrUpdate(help);
			return new ResponseObject(true,"保存成功");
		} catch (Exception e) {
			logger.error("保存帮助异常", e);
			return new ResponseObject(false,"保存异常");
		}
	}
}
